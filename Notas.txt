#Requires -RunAsAdministrator
.SYNOPSIS
    Optimizador de Sistema Windows con Interfaz Gr√°fica
.DESCRIPTION
    Script completo de optimizaci√≥n con GUI, limpieza avanzada, verificaci√≥n de sistema y registro.
.NOTES
    Requiere permisos de administrador
    Versi√≥n: 2.5.0
    Cambios v2.5.0 (Estabilidad + Deduplicaci√≥n + TaskPool):
      [LOG] Logging estructurado a archivo rotante diario:
            Write-Log centralizado ‚Äî escribe a UI + .\logs\SysOpt_YYYY-MM-DD.log.
            Rotaci√≥n autom√°tica por d√≠a. Thread-safe con Mutex de nombre.
            Write-ConsoleMain es ahora alias de Write-Log (100% compatible).
      [ERR] Error boundary global:
            AppDomain.UnhandledException captura excepciones de runspaces en background.
            Dispatcher.UnhandledException captura errores del hilo WPF.
            Ambos logean el error y muestran un di√°logo amigable en lugar de crash.
      [WMI] CimSession compartida con timeout de 5 s:
            Invoke-CimQuery reemplaza todos los Get-CimInstance directos del hilo UI.
            Si WMI tarda m√°s de 5 s, el timeout evita que la UI se congele.
            La sesi√≥n se recrea autom√°ticamente si muere o falla.
      [B5] Deduplicaci√≥n SHA256 (archivos >10 MB):
            Bot√≥n "üîç Duplicados" en la barra del Explorador de Disco.
            Hash calculado en runspace background ‚Äî UI nunca bloquea.
            Ventana de resultados con grupos, espacio recuperable y eliminaci√≥n de copias.
      [TASKPOOL] Pesta√±a "‚ö° Tareas" ‚Äî panel de operaciones en segundo plano:
            Todas las operaciones async (escaneo, CSV, HTML, dedup) se registran.
            Vista estilo torrent: nombre, barra de progreso, estado, tiempo transcurrido.
            Bot√≥n "Limpiar completadas" para purgar el historial de tareas terminadas.
            Timer de refresco de 1 s ‚Äî impacto cero en UI.
      [FIX] $dlg.Hide() null: GetNewClosure() captura $dlg en el scope de la funci√≥n.
      [FIX] $dlg.DragMove() null: idem con GetNewClosure().
      [FIX] Elapsed time en Refresh-TasksPanel: [int]+string ‚Üí interpolaci√≥n "$([int]...)s".
    Cambios v2.4.0 (FIFO Streaming Anti-RAM-Drain):
      PROBLEMA RESUELTO:
        El guardado de snapshot y la carga de entries materializaban TODA la colecci√≥n
        en RAM antes de procesarla, causando picos de consumo proporcionales al tama√±o
        del escaneo (escaneos de 50k+ carpetas pod√≠an duplicar el uso de RAM).

      [FIFO-01] Guardado de snapshot ‚Äî streaming FIFO con ConcurrentQueue + JsonTextWriter:
                ANTES: $snapData (copia 1) ‚Üí $entries (copia 2) ‚Üí $json string (copia 3)
                       ‚Üí WriteAllText. Pico = 3x RAM del dataset.
                AHORA: UI encola items 1 a 1 mientras background drena la queue y escribe
                       con JsonTextWriter directo al disco. Nunca existe el JSON en RAM.
                       Ahorro: -50% a -200% RAM en pico seg√∫n tama√±o del escaneo.

      [FIFO-02] Carga de entries ‚Äî FIFO con ConvertFrom-Json nativo + ConcurrentQueue:
                ANTES: ReadAllText + ConvertFrom-Json + ConcurrentBag acumulado completo
                       antes de entregar al hilo UI. Pico = 3x JSON en RAM.
                AHORA: ConvertFrom-Json nativo (sin Newtonsoft, funciona en cualquier
                       runspace). Entries se encolan uno a uno (FIFO) en ConcurrentQueue.
                       DispatcherTimer drena en lotes de 500/tick ‚Äî UI nunca bloquea.
                       Ahorro: -30% RAM pico (elimina ConcurrentBag intermedio).

      [FIFO-03] Terminaci√≥n limpia garantizada en ambos flujos:
                Runspace + GC.Collect() + LOH compaction liberados al terminar,
                incluso en error (bloque finally). FeedDone en hashtable sincronizada
                evita bloqueos si el productor falla antes de terminar.

    Cambios v2.3.0 (Optimizaci√≥n RAM + Rendimiento):
      OPTIMIZACIONES RAM:
        [RAM-01] DiskItem_v211: INPC eliminado del modelo de datos puros.
                 ToggleVisibility y ToggleIcon extra√≠dos a DiskItemToggle_v230
                 (wrapper INPC ligero). El objeto principal ya no retiene event
                 listeners ni PropertyChangedEventArgs. Ahorro: ~30-80 MB en
                 escaneos grandes.
        [RAM-02] Exportaci√≥n CSV: reemplazado StringBuilder por StreamWriter
                 directo (flush por lotes). Nunca se materializa todo el CSV
                 en memoria. Ahorro: ‚àí50 a ‚àí150 MB pico en exportaciones grandes.
        [RAM-02b] Exportaci√≥n HTML tabla: StreamWriter en archivo temporal para
                 las filas HTML. El StringBuilder ya no crece ilimitado.
        [RAM-03] bgExportScript y bgCsvScript reciben AllScannedItems por ref
                 via hashtable de estado compartido ‚Äî evita copia completa.
        [RAM-04] Load-SnapshotList: metadatos le√≠dos con JsonTextReader l√≠nea
                 a l√≠nea. Los Entries nunca se deserializan en memoria al listar.
                 Ahorro: ‚àí200 a ‚àí400 MB pico por snapshot grande.
        [RAM-05] RunspacePool centralizado (1-3 runspaces, ISS m√≠nimo) para
                 operaciones async de exportaci√≥n y top-files. Elimina overhead
                 de arranque y carga de m√≥dulos por operaci√≥n.
        [RAM-06] GC agresivo post-exportaci√≥n: LOH compaction + EmptyWorkingSet
                 tras cada exportaci√≥n o carga de snapshot.
      NUEVAS OPTIMIZACIONES:
        [NEW-01] DiskUiTimer: debounce de 80ms en Refresh-DiskView para evitar
                 rebuildeos m√∫ltiples en r√°fagas de datos del scanner.
        [NEW-02] Comparador de snapshots: pre-c√°lculo de top 10 archivos
                 durante el escaneo mediante acumulador en background.
        [NEW-03] AllScannedItems capacity hint: se preasigna con Capacity
                 estimado para evitar realocaciones de array interno.
        [NEW-04] chartTimer: intervalo m√≠nimo 1s en lugar de 400ms para
                 reducir presi√≥n de GC en la pesta√±a Rendimiento.
    Cambios v2.2.0 (BugFix + Paths):
      BUGS CORREGIDOS:
        [BF1] Snapshots: ruta cambiada de %APPDATA%\SysOpt\snapshots a .\snapshots
              (relativo al script) ‚Äî los snapshots ahora se guardan junto al script
        [BF2] Logs: ruta por defecto del di√°logo "Guardar log" cambiada a .\logs
              (relativo al script) ‚Äî se crea autom√°ticamente si no existe
        [BF3] Snapshots no se listaban: bug cr√≠tico en Load-SnapshotList ‚Äî clave
              de hashtable era una variable ($rootCount) dentro de @{}, lo que lanzaba
              una excepci√≥n silenciosa en el catch{} e imped√≠a a√±adir cualquier item
              a la lista. Corregido: $rootCount se calcula antes del PSCustomObject
        [BF4] Di√°logo "Confirmar eliminaci√≥n" fallaba con XML inv√°lido cuando el
              nombre del snapshot conten√≠a comillas dobles (p.ej. "Escaneo 20/02/2026").
              Corregido: $Title y $Message se escapan con &quot; antes de interpolarlos
              en el XAML. Aplicado tambi√©n a Show-ThemedInput.
        [BF5] Alto consumo de RAM: Load-SnapshotList cargaba todos los Entries de
              todos los JSONs en memoria permanentemente. Ahora solo guarda metadatos
              (FilePath, Label, fechas, conteos) y lee Entries bajo demanda al
              seleccionar o comparar, liberando la referencia inmediatamente tras su uso.
        [BF6] Comparar bloqueaba la UI: el bucle de "carpetas nuevas" era O(n¬≤)
              ‚Äî por cada item del escaneo actual iteraba todos los Entries del snapshot.
              Corregido con un HashSet<string> (lookup O(1)) y un Dictionary<string,long>
              para el mapa de tama√±os. El comparador ahora escala correctamente aunque
              el escaneo o el snapshot contengan decenas de miles de carpetas.
      NUEVAS FUNCIONES v2.2.0:
        [N1] Snapshots con CheckBox: cada snapshot tiene un checkbox para seleccion
             individual. Boton "Todo" para marcar/desmarcar todos de golpe.
             El contador muestra "N de M seleccionados" en tiempo real.
        [N2] Comparar mejorado: soporta 3 modos segun los checks marcados:
               - 1 check + escaneo actual cargado ‚Üí snapshot vs escaneo actual
               - 2 checks ‚Üí snapshot A vs snapshot B (comparacion historica)
             El boton cambia de texto dinamicamente segun el modo activo.
        [N3] Eliminar en lote: elimina todos los snapshots marcados de una sola vez
             con dialogo de confirmacion que lista los nombres afectados.
    Cambios v2.1.3 (UX + BugFix):
      MEJORAS UX:
        [U1]  ComboBox con estilo oscuro tem√°tico (ya no aparece blanco)
        [U2]  ContextMenu / MenuItem con estilo oscuro tem√°tico
        [U3]  Botones de consola Output funcionales: rojo=ocultar, amarillo=minimizar/restaurar,
              verde=expandir/restaurar. Bot√≥n "üñ• Output" en footer para reabrir.
        [U4]  Men√∫ contextual del Explorador incluye "Mostrar Output"
        [U5]  Enlace GitHub en el About abre el navegador al hacer clic
      BUGS CORREGIDOS v2.1.2:
        [BF4] Logo: carga v√≠a $script:AppDir unificado
        [BF5] cmbRefreshInterval.SelectionChanged: timer se recrea correctamente
        [BF6] Get-SizeColorFromStr duplicado eliminado
    Cambios v2.0.2 (BugFix):
      BUGS CORREGIDOS:
        [BF1] Pesta√±a Rendimiento ‚Üí Red: ahora muestra velocidad de subida/bajada
              en tiempo real (delta bytes/s), detecta Ethernet vs WiFi por PhysicalMediaType
              e InterfaceDescription, e indica el tipo con icono üì∂/üîå
        [BF2] Explorador de Disco: escaneo ahora es verdaderamente recursivo ‚Äî
              emite subcarpetas con indentaci√≥n visual en tiempo real durante el barrido;
              se a√±ade propiedad Depth al objeto de cola y a ScanCtl211.Current
        [BF3] Cierre del programa: Add_Closed vac√≠a la cola ConcurrentQueue, limpia
              LiveList/LiveItems, dispone el runspace de escaneo y el CancelTokenSource
              de optimizaci√≥n ‚Üí evita errores de estado cacheado al relanzar
        [BF3b] ScanControl: a√±adida propiedad Current (volatile string) que faltaba
               en la clase C# ‚Äî corrige NullRef al leer [ScanCtl211]::Current
      BUGS CORREGIDOS:
        [B1]  GC.Collect reemplazado por EmptyWorkingSet real via Win32 API (RAM real)
        [B2]  CleanRegistry ahora exige BackupRegistry o muestra advertencia bloqueante
        [B3]  Mutex con AbandonedMutexException ‚Äî ya no bloquea tras crash
        [B4]  chkAutoRestart sincronizado con btnSelectAll correctamente
        [B5]  Detecci√≥n SSD por DeviceID en lugar de FriendlyName
        [B6]  Opera / Opera GX / Brave con rutas de cach√© completas
        [B7]  Firefox: limpia cache y cache2 (legacy + moderno)
        [B8]  Timer valida runspace con try/catch ‚Äî no queda bloqueado
        [B9]  CHKDSK: orden corregido (dirty set ANTES de chkntfs)
        [B10] btnSelectAll refleja estado real de todos los checkboxes
        [B11] Aviso antes de limpiar consola si tiene contenido
        [B12] Formato de duraci√≥n corregido a dd\:hh\:mm\:ss
        [B13] Limpieza de temporales refactorizada en funci√≥n reutilizable
      NUEVAS FUNCIONES:
        [N1]  Panel de informaci√≥n del sistema (RAM, disco, CPU) al iniciar
        [N2]  Modo Dry Run (an√°lisis sin cambios)
        [N3]  Limpieza de Windows Update Cache (SoftwareDistribution\Download)
        [N4]  Limpieza de Event Viewer Logs (System, Application, Setup)
        [N5]  Gestor de programas de inicio (ver y desactivar entradas de autoarranque)
      MEJORAS INTERNAS:
        [M1]  Clean-TempPaths ‚Äî funci√≥n unificada para limpieza de carpetas temp
        [M2]  Dependencia BackupRegistry ‚Üî CleanRegistry
        [M3]  Detecci√≥n de disco robusta via DeviceID
        [M4]  AbandonedMutexException manejada
        [M5]  Rutas de navegadores completadas

----------------------------------------------------------------------------------------------------------
Notas

DLL: (completado)
Necesito cuentes las entradas de Add-Type, necesito que se cree un archive dll por cada Add-Type diferente
DLL_ROADMAP UPDATE:
Acabo de implementar la dll en el sistema, apunta a la ruta .\libs los archivos, en el script sigue apareciendo la versi√≥n 2.5.0 actualizalo a la versi√≥n 3.0.0 (Dev) y actualiza el roadmap y el readme.md.

CHK:
Volvamos a la versi√≥n anterior (SysOpt 3.0.ps1), quiero que soluciones el glitch: Exception setting "ItemsSource": "Cannot convert the "@{DiskName=KXG70ZNV512G NVMe KIOXIA 512GB; Status=Healthy; StatusBg=
#182A1E; StatusFg=
#4AE896; 
Attributes=System.Collections.Generic.List`1[System.Object]}" value of type "System.Management.Automation.PSCustomObject" to type "System.Collections.IEnumerable"."
At C:\Users\e_dgarrote\Downloads\SysOpt\SysOpt 3.0\SysOpt 3.0.ps1:3214 char:5
+     $icSmartDisks.ItemsSource = $smartData
+     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [], SetValueInvocationException
    + FullyQualifiedErrorId : ExceptionWhenSetting

Y adem√°s que en vez de aparecer .NOTES, aparezca como en las versi√≥n anterior (SysOpt.ps1) con un metadata

C1:
Dentro del roadmap en la versi√≥n 3.0 empezaremos con la C1, necesito que los temas se apliquen en un archivo externo, cada tema ser√° un archivo distinto y se encontrar√°n en las carpeta .\assets\themes\ quiero que la app sea compatible con varios temas que pueda crear la comunidad, o generame distintos temas, estilo windows 11, estilo linux, estilo macOS, estilo manga... En la app tiene que estar entre task y about un bot√≥n que sea para cambiar el tema. Se deber√° exportar el archivo de tema actual a default y almacenala en la ruta y crea una extensi√≥n legible desde cualquier editor de texto.

Limpieza de script: 
Quiero que toda la info .NOTES deje de aparecer como comentario y aparezca a partir de ahora en el about e incluso en un archive externo